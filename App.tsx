import React, { useState, useEffect, useMemo, useRef } from 'react';
import { MOCK_BANNERS } from './constants';
import { Profile, Article, FilterCriteria } from './types';
import { ProfileDetail } from './components/ProfileDetail';
import { AdminEditor } from './components/AdminEditor';
import { SidebarFilter } from './components/SidebarFilter';
import { NewsList } from './components/NewsList';
import { ArticleDetail } from './components/ArticleDetail';
import { AdminArticleEditor } from './components/AdminArticleEditor';
import { PageTransition } from './components/PageTransition';
import { PriceDisplay } from './components/PriceDisplay';
import { ProviderListingPage } from './components/ProviderListingPage';
import { ProviderDashboard } from './components/ProviderDashboard';
import { UserProfile } from './components/UserProfile';
import { UserBlogPage } from './components/UserBlogPage';
import { ForumPage } from './components/ForumPage';
import { PostDetail } from './components/PostDetail';
import { CreatePostPage } from './components/CreatePostPage';
import { AboutTeaKing } from './components/AboutTeaKing';
import { NotFound } from './components/NotFound';
import { Footer } from './components/Footer';
import { MembershipBadge } from './components/MembershipBadge';
import { NotificationBox } from './components/NotificationBox';
import { VerificationBadges } from './components/VerificationBadges';
import { VipBadge } from './components/VipBadge';
import { AdminBadge } from './components/AdminBadge';
import { FavoriteButton } from './components/FavoriteButton';
import { AuthProvider, useAuth } from './contexts/AuthContext';
import { AuthModal } from './components/AuthModal';
import { WelcomeModal } from './components/WelcomeModal';
import { profilesApi, articlesApi } from './services/apiService';
import { getImageUrl } from './config/api';

type ViewState = 'HOME' | 'NEWS' | 'PROFILE_DETAIL' | 'ADMIN_PROFILE' | 'ARTICLE_DETAIL' | 'PROVIDER_LISTING' | 'PROVIDER_DASHBOARD' | 'USER_PROFILE' | 'USER_BLOG' | 'FORUM' | 'CREATE_POST' | 'ABOUT' | 'NOT_FOUND';

const App: React.FC = () => {
  // 從後端 API 獲取資料
  const [profiles, setProfiles] = useState<Profile[]>([]);
  const [articles, setArticles] = useState<Article[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const [filters, setFilters] = useState<FilterCriteria>({
    type: 'all',
    location: '全部',
    nationalities: [],
    bodyTypes: [],
    personalities: [],
    ageRange: [18, 80],
    priceRange: [0, 200000], // 提高上限到20万，确保所有价格都能显示
    cup: []
  });

  const [currentView, setCurrentView] = useState<ViewState>('ABOUT');
  const [selectedProfile, setSelectedProfile] = useState<Profile | null>(null);
  const [selectedArticle, setSelectedArticle] = useState<Article | null>(null);
  const [editingProfile, setEditingProfile] = useState<Profile | null>(null);
  const [editingArticle, setEditingArticle] = useState<Article | null>(null);
  const [profileDetailSource, setProfileDetailSource] = useState<ViewState>('HOME'); // 跟踪详情页的来源页面
  const [isTransitioning, setIsTransitioning] = useState(false);
  const [isMobileNavOpen, setIsMobileNavOpen] = useState(false);
  const [isFilterOpen, setIsFilterOpen] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [showAuthModal, setShowAuthModal] = useState(false);
  const [authModalMode, setAuthModalMode] = useState<'login' | 'register'>('login');
  const [currentPage, setCurrentPage] = useState(1); // 当前页码
  const [itemsPerPage] = useState(12); // 每页显示数量
  const [selectedPostId, setSelectedPostId] = useState<string | null>(null); // 選中的御茶室茶帖ID
  const [selectedUserId, setSelectedUserId] = useState<string | null>(null); // 選中的用戶ID（用於查看用戶個人頁面）
  const [previousView, setPreviousView] = useState<ViewState | null>(null); // 追蹤之前的視圖（用於返回按鈕）
  
  const { user, isAuthenticated, logout, showWelcomeModal, setShowWelcomeModal } = useAuth();

  // 首次進入網站時顯示 3 秒茶王動態效果
  useEffect(() => {
    setIsTransitioning(true);
    const timer = setTimeout(() => {
      setIsTransitioning(false);
    }, 3000);
    return () => clearTimeout(timer);
  }, []);

  // 從後端 API 載入資料（優化：先顯示緩存，後台更新）
  const isLoadingDataRef = useRef(false);
  
  const loadData = async () => {
    // 防止重複請求
    if (isLoadingDataRef.current) {
      return;
    }

    setError(null);
    
    // 先從 localStorage 讀取緩存數據，立即顯示（提升用戶體驗和 LCP）
    let hasValidCache = false;
    try {
      const cachedProfiles = localStorage.getItem('sf_profiles_v1');
      const cachedArticles = localStorage.getItem('sf_articles_v1');
      
      if (cachedProfiles) {
        try {
          const profiles = JSON.parse(cachedProfiles);
          if (profiles && profiles.length > 0) {
            setProfiles(profiles);
            hasValidCache = true;
            if (import.meta.env.DEV) {
              console.log(`[緩存] 已載入 ${profiles.length} 個 profiles`);
            }
          }
        } catch (e) {
          console.warn('無法解析緩存的 profiles:', e);
        }
      }
      
      if (cachedArticles) {
        try {
          const articles = JSON.parse(cachedArticles);
          if (articles && articles.length > 0) {
            setArticles(articles);
            hasValidCache = true;
            if (import.meta.env.DEV) {
              console.log(`[緩存] 已載入 ${articles.length} 個 articles`);
            }
          }
        } catch (e) {
          console.warn('無法解析緩存的 articles:', e);
        }
      }
    } catch (e) {
      console.warn('讀取緩存失敗:', e);
    }
    
    // 只有在沒有有效緩存時才顯示 loading
    if (!hasValidCache) {
      setIsLoading(true);
    }
    
    // 然後在後台從 API 獲取最新數據
    try {
      isLoadingDataRef.current = true;
      
      // 嚴選好茶需要顯示所有 profiles（因為需要篩選出 userId 為空的）
      // ==================== 首頁載入順序調整（避免同時發送大量請求）====================
      // 按照規格書：先串行載入關鍵數據，然後並行載入次要數據
      
      // 1. 先載入 profiles（關鍵數據，串行）
      const INITIAL_PROFILES_LIMIT = 100;
      const profilesResult = await Promise.allSettled([
        profilesApi.getAll({ limit: INITIAL_PROFILES_LIMIT, offset: 0 })
      ]).then(results => results[0]);
      
      // 2. 然後載入 articles（關鍵數據，串行）
      const INITIAL_ARTICLES_LIMIT = 20;
      const articlesResult = await Promise.allSettled([
        articlesApi.getAll({ limit: INITIAL_ARTICLES_LIMIT, offset: 0 })
      ]).then(results => results[0]);
      
      // 如果第一頁還有更多數據，繼續載入
      if (profilesResult.status === 'fulfilled' && profilesResult.value.hasMore) {
        const firstPageProfiles = profilesResult.value.profiles || [];
        const total = profilesResult.value.total || 0;
        const remaining = total - firstPageProfiles.length;
        
        if (remaining > 0) {
          // 載入剩餘的數據
          try {
            const remainingResult = await profilesApi.getAll({ 
              limit: remaining, 
              offset: firstPageProfiles.length 
            });
            const allProfiles = [...firstPageProfiles, ...(remainingResult.profiles || [])];
            setProfiles(allProfiles);
            
            // 更新緩存（只保存必要字段）
            try {
              const profilesForCache = allProfiles.map(p => ({
                id: p.id,
                name: p.name,
                nationality: p.nationality,
                age: p.age,
                height: p.height,
                weight: p.weight,
                cup: p.cup,
                location: p.location,
                district: p.district,
                type: p.type,
                imageUrl: p.imageUrl,
                price: p.price,
                prices: p.prices,
                tags: p.tags,
                isAvailable: p.isAvailable,
                isNew: p.isNew,
                userId: p.userId,
              }));
              localStorage.setItem('sf_profiles_v1', JSON.stringify(profilesForCache));
              localStorage.setItem('sf_profiles_total', total.toString());
              if (import.meta.env.DEV) {
                console.log(`[API] 已載入所有 ${allProfiles.length} 個 profiles（分頁載入）`);
              }
            } catch (cacheError: any) {
              if (cacheError.name !== 'QuotaExceededError') {
                console.warn('無法保存所有 profiles 到緩存:', cacheError);
              }
            }
          } catch (remainingError) {
            // 如果載入剩餘數據失敗，至少使用第一頁的數據
            console.warn('載入剩餘 profiles 失敗，使用第一頁數據:', remainingError);
          }
        }
      }
      
      // 處理 profiles 結果（如果沒有分頁載入，則使用第一頁數據）
      if (profilesResult.status === 'fulfilled') {
        const result = profilesResult.value;
        // 如果沒有執行分頁載入（hasMore 為 false 或 remaining <= 0），則使用第一頁數據
        if (!result.hasMore || (result.total || 0) <= (result.profiles || []).length) {
          const profiles = result.profiles || [];
          setProfiles(profiles);
          // 更新緩存 - 優化：只保存必要字段，避免 localStorage 配額超限
          try {
            const profilesForCache = profiles.map(p => ({
              id: p.id,
              name: p.name,
              nationality: p.nationality,
              age: p.age,
              height: p.height,
              weight: p.weight,
              cup: p.cup,
              location: p.location,
              district: p.district,
              type: p.type,
              imageUrl: p.imageUrl,
              price: p.price,
              prices: p.prices,
              tags: p.tags,
              isAvailable: p.isAvailable,
              isNew: p.isNew,
              userId: p.userId,
            }));
            localStorage.setItem('sf_profiles_v1', JSON.stringify(profilesForCache));
            localStorage.setItem('sf_profiles_total', result.total?.toString() || '0');
            localStorage.setItem('sf_profiles_hasMore', result.hasMore?.toString() || 'false');
            if (import.meta.env.DEV) {
              console.log(`[API] 已更新 ${profiles.length} 個 profiles（總共 ${result.total} 個）`);
            }
          } catch (e: any) {
            if (e.name !== 'QuotaExceededError') {
              console.warn('無法保存 profiles 到緩存:', e);
            }
          }
        }
      } else {
        console.warn('載入 profiles 失敗:', profilesResult.reason);
        // 如果沒有緩存數據，設置錯誤
        if (!localStorage.getItem('sf_profiles_v1')) {
          setError('無法載入 profiles，請檢查後端連線');
        }
      }
      
      // 處理 articles 結果
      if (articlesResult.status === 'fulfilled') {
        const result = articlesResult.value;
        const articles = result.articles || [];
        setArticles(articles);
        // 更新緩存
        try {
          localStorage.setItem('sf_articles_v1', JSON.stringify(articles));
          if (import.meta.env.DEV) {
            console.log(`[API] 已更新 ${articles.length} 個 articles（總共 ${result.total} 個）`);
          }
        } catch (e) {
          console.warn('無法保存 articles 到緩存:', e);
        }
      } else {
        console.warn('載入 articles 失敗:', articlesResult.reason);
        // 如果沒有緩存數據，設置錯誤
        if (!localStorage.getItem('sf_articles_v1')) {
          setError('無法載入 articles，請檢查後端連線');
        }
      }
      
      // 如果兩個都失敗且沒有緩存，設置錯誤訊息
      if (profilesResult.status === 'rejected' && articlesResult.status === 'rejected' 
          && !localStorage.getItem('sf_profiles_v1') && !localStorage.getItem('sf_articles_v1')) {
        setError('無法載入資料，請檢查後端連線');
      }
    } catch (err: any) {
      console.error('載入資料失敗:', err);
      // 只有在沒有緩存數據時才顯示錯誤
      if (!localStorage.getItem('sf_profiles_v1') && !localStorage.getItem('sf_articles_v1')) {
        setError(err.message || '無法載入資料，請檢查後端連線');
      }
    } finally {
      setIsLoading(false);
      isLoadingDataRef.current = false;
    }
  };

  // 初始載入（使用 useRef 防止重複載入）
  const hasLoadedRef = useRef(false);
  useEffect(() => {
    if (!hasLoadedRef.current) {
      hasLoadedRef.current = true;
      loadData();
    }
  }, []);

  // 處理 URL 參數，當有 ?post= 時自動跳轉到對應的茶帖
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('post');
    const articleId = urlParams.get('article');
    const profileId = urlParams.get('profile');
    
    // 檢查是否有 404 參數（用於手動觸發 404 頁面）
    if (urlParams.get('404') === 'true') {
      setCurrentView('NOT_FOUND');
      return;
    }
    
    if (postId) {
      // 清除 URL 參數，避免刷新時重複處理
      window.history.replaceState({}, '', window.location.pathname);
      // 導航到御茶室並設置選中的茶帖
      setCurrentView('FORUM');
      setSelectedPostId(postId);
    } else if (articleId) {
      // 處理文章 ID
      const article = articles.find(a => a.id === articleId);
      if (article) {
        setCurrentView('ARTICLE_DETAIL');
        setSelectedArticle(article);
        window.history.replaceState({}, '', window.location.pathname);
      } else if (articles.length > 0) {
        // 如果文章列表已載入但找不到對應文章，顯示 404
        setCurrentView('NOT_FOUND');
      }
    } else if (profileId) {
      // 處理 Profile ID
      const profile = profiles.find(p => p.id === profileId);
      if (profile) {
        setCurrentView('PROFILE_DETAIL');
        setSelectedProfile(profile);
        window.history.replaceState({}, '', window.location.pathname);
      } else if (profiles.length > 0) {
        // 如果 Profile 列表已載入但找不到對應 Profile，顯示 404
        setCurrentView('NOT_FOUND');
      }
    }
  }, [articles, profiles]);

  // 監聽通知導航事件
  useEffect(() => {
    const handleNavigateToUserProfile = (event: CustomEvent) => {
      const { tab } = event.detail || {};
      handleNavigation('USER_PROFILE');
      // 發送設置 tab 的事件
      if (tab) {
        setTimeout(() => {
          window.dispatchEvent(new CustomEvent('user-profile-set-tab', { detail: { tab } }));
        }, 100);
      }
    };

    const handleNavigateToForum = () => {
      handleNavigation('FORUM');
    };

    const handleNavigateToForumPost = (event: CustomEvent) => {
      const { postId } = event.detail || {};
      if (postId) {
        setSelectedPostId(postId);
        handleNavigation('POST_DETAIL');
      }
    };

    const handleNavigateToProfile = (event: CustomEvent) => {
      const { profileId } = event.detail || {};
      if (profileId) {
        const profile = profiles.find(p => p.id === profileId);
        if (profile) {
          handleNavigation('PROFILE_DETAIL', profile);
        }
      }
    };

    const handleNavigateToUserBlog = (event: CustomEvent) => {
      const { userId } = event.detail || {};
      
      // 詳細的調試日誌
      if (import.meta.env.DEV) {
        console.log('[導航] 收到 navigate-to-user-blog 事件', { 
          userId, 
          userIdType: typeof userId,
          userIdLength: userId?.length,
          detail: event.detail 
        });
      }
      
      // 確保 userId 存在且不為空字符串
      if (userId && typeof userId === 'string' && userId.trim() !== '') {
        const trimmedUserId = userId.trim();
        // 保存當前的視圖作為之前的視圖
        setPreviousView(currentView);
        setSelectedUserId(trimmedUserId);
        handleNavigation('USER_BLOG');
        
        if (import.meta.env.DEV) {
          console.log('[導航] 成功導航到用戶頁面', { userId: trimmedUserId });
        }
      } else {
        console.warn('無法導航到用戶頁面：userId 為空或未定義', { 
          userId, 
          userIdType: typeof userId,
          detail: event.detail 
        });
        // 如果 userId 無效，不進行導航，避免顯示錯誤頁面
        alert('無法查看該用戶的公開檔案：用戶ID無效');
      }
    };

    const handleNavigate = (event: CustomEvent) => {
      const { view } = event.detail || {};
      if (view === 'PROVIDER_LISTING') {
        handleNavigation('PROVIDER_LISTING');
      }
    };

    window.addEventListener('navigate-to-user-profile', handleNavigateToUserProfile as EventListener);
    window.addEventListener('navigate-to-forum', handleNavigateToForum);
    window.addEventListener('navigate-to-forum-post', handleNavigateToForumPost as EventListener);
    window.addEventListener('navigate-to-profile', handleNavigateToProfile as EventListener);
    window.addEventListener('navigate-to-user-blog', handleNavigateToUserBlog as EventListener);
    window.addEventListener('navigate', handleNavigate as EventListener);

    return () => {
      window.removeEventListener('navigate-to-user-profile', handleNavigateToUserProfile as EventListener);
      window.removeEventListener('navigate-to-forum', handleNavigateToForum);
      window.removeEventListener('navigate-to-forum-post', handleNavigateToForumPost as EventListener);
      window.removeEventListener('navigate-to-profile', handleNavigateToProfile as EventListener);
      window.removeEventListener('navigate-to-user-blog', handleNavigateToUserBlog as EventListener);
      window.removeEventListener('navigate', handleNavigate as EventListener);
    };
  }, [profiles, currentView]);

  // 當切換到 HOME 或 NEWS 時，重新載入資料（確保顯示最新資料）
  useEffect(() => {
    if (currentView === 'HOME' || currentView === 'NEWS') {
      // 如果有緩存數據，不立即重新載入，避免影響 LCP
      // 只在沒有緩存時才載入，或延遲載入（後台更新）
      const hasCache = currentView === 'NEWS' 
        ? localStorage.getItem('sf_articles_v1')
        : localStorage.getItem('sf_profiles_v1');
      
      if (!hasCache) {
        // 沒有緩存時立即載入
        loadData();
      } else {
        // 有緩存時延遲載入（後台更新），不影響顯示
        const timer = setTimeout(() => {
          loadData();
        }, 2000);
        return () => clearTimeout(timer);
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [currentView]);

  // 重置所有篩選並重新載入資料
  const handleResetFilters = () => {
    setFilters({
      type: 'all',
      location: '全部',
      nationalities: [],
      bodyTypes: [],
      personalities: [],
      ageRange: [18, 80],
      priceRange: [0, 200000],
      cup: []
    });
    loadData();
  };

  // 搜索功能
  const searchProfiles = (profiles: Profile[], query: string): Profile[] => {
    if (!query.trim()) return profiles;
    
    const lowerQuery = query.toLowerCase().trim();
    return profiles.filter(p => {
      // 搜索名字
      if (p.name.toLowerCase().includes(lowerQuery)) return true;
      // 搜索地区
      if (p.location.toLowerCase().includes(lowerQuery)) return true;
      // 搜索标签
      if (p.tags?.some(tag => tag.toLowerCase().includes(lowerQuery))) return true;
      // 搜索服务
      if (p.basicServices?.some(service => service.toLowerCase().includes(lowerQuery))) return true;
      if (p.addonServices?.some(service => service.toLowerCase().includes(lowerQuery))) return true;
      return false;
    });
  };

  // 篩選 + 搜索 + 隨機排序（本月精選隨機出現）
  const filteredProfiles = useMemo(() => {
    // 先应用搜索
    let result = searchProfiles(profiles, searchQuery);
    
    // 嚴選好茶页面只显示后台管理员上架的profiles（userId为空或null）
    if (currentView === 'HOME') {
      result = result.filter(p => {
        // 只显示userId为空、null、undefined或空字符串的profiles（高级茶）
        // 如果userId不存在、为null、undefined或空字符串，则显示
        const hasUserId = p.userId && p.userId !== '' && p.userId !== null && p.userId !== undefined;
        return !hasUserId;
      });
    }
    
    // 再应用筛选
    result = result.filter(p => {
      const tags = p.tags || [];
      // 获取实际价格：优先使用prices.oneShot.price，如果没有则使用price字段
      const actualPrice = p.prices?.oneShot?.price || p.price || 0;
      const priceValue = typeof actualPrice === 'number' ? actualPrice : Number(actualPrice || 0);

      const matchType = filters.type === 'all' || p.type === filters.type;
      const matchLoc = filters.location === '全部' || p.location === filters.location;
      const matchNat = filters.nationalities.length === 0 || filters.nationalities.includes(p.nationality);
      const matchCup = filters.cup.length === 0 || filters.cup.includes(p.cup);
      // 价格过滤：移除价格上限限制，所有价格都能显示
      const matchPrice = true; // 移除价格上限限制，所有价格都能显示
      // 年龄过滤：放宽限制，允许所有年龄（0-200）
      const matchAge = p.age >= 0 && p.age <= 200; // 放宽年龄限制
      // 身材條件和風格特質：如果用戶沒有選擇，則通過；如果選擇了，檢查tags中是否包含
      const matchBody = filters.bodyTypes.length === 0 || filters.bodyTypes.some(tag => tags.includes(tag));
      const matchPersonality = filters.personalities.length === 0 || filters.personalities.some(tag => tags.includes(tag));
      
      const shouldShow = matchType && matchLoc && matchNat && matchCup && matchPrice && matchAge && matchBody && matchPersonality;
      
      return shouldShow;
    });

    // Fisher-Yates shuffle
    const shuffled = [...result];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    
    return shuffled;
  }, [profiles, filters, searchQuery, currentView]);

  // 分页逻辑
  const totalPages = Math.ceil(filteredProfiles.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedProfiles = filteredProfiles.slice(startIndex, endIndex);

  // 当筛选条件改变时，重置到第一页
  useEffect(() => {
    setCurrentPage(1);
  }, [filters, searchQuery, currentView]);

  // 導航核心邏輯 (縮短轉場延遲)
  const handleNavigation = (view: ViewState, data?: any) => {
    setIsMobileNavOpen(false);
    setIsTransitioning(true);
    setTimeout(() => {
        // 如果导航到详情页，记录来源页面
        if (view === 'PROFILE_DETAIL') {
          setSelectedProfile(data);
          setProfileDetailSource(currentView); // 记录来源页面
          setCurrentView(view);
        } else if (view === 'FORUM') {
          setSelectedPostId(null); // 重置選中的茶帖
          setCurrentView(view);
        } else {
          setCurrentView(view);
        }
        if (view === 'ARTICLE_DETAIL') setSelectedArticle(data);
        if (view === 'HOME' || view === 'NEWS' || view === 'PROVIDER_LISTING') {
            setSelectedProfile(null);
            setSelectedArticle(null);
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
        setIsTransitioning(false);
    }, 3000); // 保持與進場動畫一致，停留約 3 秒
  };

  const handleSaveProfile = (savedProfile: Profile) => {
    setProfiles(prev => {
        const exists = prev.find(p => p.id === savedProfile.id);
        if (exists) return prev.map(p => p.id === savedProfile.id ? savedProfile : p);
        return [savedProfile, ...prev];
    });
    handleNavigation('HOME');
  };

  const handleDeleteProfile = async (e: React.MouseEvent, id: string) => {
    e.stopPropagation();
    if(!window.confirm("確定下架此項目？")) {
      return;
    }
    
    try {
      // 調用後端 API 刪除
      await profilesApi.delete(id);
      // 刪除成功後重新載入資料
      await loadData();
    } catch (err: any) {
      console.error('刪除失敗:', err);
      alert('刪除失敗: ' + (err.message || '無法連接到後端'));
    }
  };

  return (
    <div className="min-h-screen bg-[#fcfdfe] text-brand-black font-sans">
      <PageTransition isVisible={isTransitioning} />

      {/* 導覽列 */}
      <header className="bg-white/95 backdrop-blur-md sticky top-0 z-50 border-b h-20 flex items-center shadow-sm relative" style={{
        borderBottom: '2px solid rgba(26, 95, 63, 0.1)',
        boxShadow: '0 2px 4px -1px rgba(26, 95, 63, 0.1)'
      }}>
        <div className="max-w-7xl mx-auto px-4 w-full flex items-center justify-center md:justify-between relative">
          {/* 手機版漢堡選單（靠左） */}
          <button
            className="md:hidden flex flex-col items-center justify-center w-10 h-10 rounded-full border border-gray-200 text-gray-700 bg-white shadow-sm absolute left-4 top-1/2 -translate-y-1/2 space-y-1 z-10"
            aria-label="Open navigation"
            onClick={() => setIsMobileNavOpen(prev => !prev)}
          >
            <span className="block w-6 h-[2px] bg-gray-800 rounded-full" />
            <span className="block w-6 h-[2px] bg-gray-800 rounded-full" />
            <span className="block w-6 h-[2px] bg-gray-800 rounded-full" />
          </button>

          {/* 手機版通知鈴鐺（右上角） */}
          {isAuthenticated && (
            <div className="md:hidden absolute right-4 top-1/2 -translate-y-1/2 z-10">
              <NotificationBox />
            </div>
          )}

          {/* Logo + 標題置中（手機版） */}
          <div className="flex items-center gap-2 md:gap-10">
            <button
              className="flex items-center gap-2 cursor-pointer group"
              onClick={() => handleNavigation('ABOUT')}
            >
              <div className="w-[50px] h-[50px] flex items-center justify-center overflow-hidden relative flag-container" style={{
                background: 'transparent'
              }}>
                <img
                  src={getImageUrl("/images/關於茶王/旗幟.png")}
                  alt="茶王旗幟"
                  className="w-full h-full object-contain group-hover:brightness-110 transition-all duration-300"
                  style={{
                    filter: 'drop-shadow(0 2px 4px rgba(26, 95, 63, 0.3))',
                    animation: 'flagWave 3s ease-in-out infinite',
                    transformOrigin: 'center center',
                    width: '50px',
                    height: 'auto'
                  }}
                  onError={(e) => {
                    // 如果圖片載入失敗，顯示文字作為備用
                    const target = e.target as HTMLImageElement;
                    if (target.parentElement) {
                      target.parentElement.innerHTML = '<span class="text-white font-black text-2xl" style="background: linear-gradient(135deg, #1a5f3f 0%, #15803d 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">茶</span>';
                    }
                  }}
                />
                <style>{`
                  @keyframes flagWave {
                    0%, 100% {
                      transform: scale(1) rotate(0deg);
                    }
                    25% {
                      transform: scale(1.05) rotate(1deg);
                    }
                    50% {
                      transform: scale(1) rotate(0deg);
                    }
                    75% {
                      transform: scale(1.05) rotate(-1deg);
                    }
                  }
                `}</style>
              </div>
              <div className="flex flex-col items-start leading-tight">
                <h1 className="text-2xl font-serif font-black tracking-tight text-brand-black">
                  茶王
                </h1>
                <p className="text-[10px] text-gray-500 font-medium mt-0.5">
                  一本道品茶，只為懂茶的你
                </p>
              </div>
            </button>

            {/* 桌面版導覽列 */}
            <nav className="hidden md:flex gap-8 ml-8">
              <button 
                onClick={() => handleNavigation('HOME')} 
                className={`text-xs font-black tracking-widest uppercase transition-all pb-1 border-b-2 elegant-hover ${currentView === 'HOME' ? 'text-brand-yellow border-brand-yellow' : 'text-gray-400 border-transparent hover:text-brand-black'}`}
                style={currentView === 'HOME' ? { color: '#1a5f3f', borderColor: '#1a5f3f' } : {}}
              >
                嚴選好茶
              </button>
              <button 
                onClick={() => handleNavigation('PROVIDER_LISTING')} 
                className={`text-xs font-black tracking-widest uppercase transition-all pb-1 border-b-2 elegant-hover ${currentView === 'PROVIDER_LISTING' ? 'text-brand-yellow border-brand-yellow' : 'text-gray-400 border-transparent hover:text-brand-black'}`}
                style={currentView === 'PROVIDER_LISTING' ? { color: '#1a5f3f', borderColor: '#1a5f3f' } : {}}
              >
                特選魚市
              </button>
              <button 
                onClick={() => handleNavigation('FORUM')} 
                className={`text-xs font-black tracking-widest uppercase transition-all pb-1 border-b-2 elegant-hover ${currentView === 'FORUM' || currentView === 'POST_DETAIL' || currentView === 'CREATE_POST' ? 'text-brand-yellow border-brand-yellow' : 'text-gray-400 border-transparent hover:text-brand-black'}`}
                style={currentView === 'FORUM' || currentView === 'POST_DETAIL' || currentView === 'CREATE_POST' ? { color: '#1a5f3f', borderColor: '#1a5f3f' } : {}}
              >
                御茶室
              </button>
              <button 
                onClick={() => handleNavigation('NEWS')} 
                className={`text-xs font-black tracking-widest uppercase transition-all pb-1 border-b-2 elegant-hover ${currentView === 'NEWS' || currentView === 'ARTICLE_DETAIL' ? 'text-brand-yellow border-brand-yellow' : 'text-gray-400 border-transparent hover:text-brand-black'}`}
                style={currentView === 'NEWS' || currentView === 'ARTICLE_DETAIL' ? { color: '#1a5f3f', borderColor: '#1a5f3f' } : {}}
              >
                御前茶訊
              </button>
              <button 
                onClick={() => handleNavigation('ABOUT')} 
                className={`text-xs font-black tracking-widest uppercase transition-all pb-1 border-b-2 elegant-hover ${currentView === 'ABOUT' ? 'text-brand-yellow border-brand-yellow' : 'text-gray-400 border-transparent hover:text-brand-black'}`}
                style={currentView === 'ABOUT' ? { color: '#1a5f3f', borderColor: '#1a5f3f' } : {}}
              >
                關於茶王
              </button>
            </nav>
          </div>
          
          {/* 桌面版右側按鈕 */}
          <div className="hidden md:flex items-center gap-4">
            {isAuthenticated ? (
              <>
                <NotificationBox />
                <button
                  onClick={() => handleNavigation('USER_PROFILE')}
                  className="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50"
                >
                  {user?.role === 'provider' ? '佳麗檔案' : '茶客檔案'}
                </button>
                <button 
                  onClick={logout}
                  className="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50"
                >
                  登出
                </button>
              </>
            ) : (
              <button 
                onClick={() => {
                  setShowAuthModal(true);
                  setAuthModalMode('login');
                }}
                className="premium-button text-white px-6 py-2 rounded-lg font-medium text-sm transition-all shadow-md"
              >
                登入/註冊
              </button>
            )}
            <a 
              href="https://lin.ee/wPxjsSG"
              target="_blank"
              rel="noopener noreferrer"
              className="premium-button text-white px-8 py-3 rounded-full font-black text-xs tracking-widest uppercase transition-all shadow-md inline-block text-center"
            >
              聯絡客服
            </a>
          </div>
        </div>
        
        {/* 手機版下拉選單 */}
        {isMobileNavOpen && (
          <div className="md:hidden absolute top-20 inset-x-0 bg-white border-b border-gray-100 shadow-sm z-40">
            <div className="max-w-7xl mx-auto px-4 py-3 flex flex-col gap-2">
              <button
                onClick={() => handleNavigation('HOME')}
                className={`text-sm text-left py-2 elegant-hover ${currentView === 'HOME' ? 'font-black' : 'text-gray-700'}`}
                style={currentView === 'HOME' ? { color: '#1a5f3f' } : {}}
              >
                嚴選好茶
              </button>
              <button
                onClick={() => {
                  handleNavigation('PROVIDER_LISTING');
                  setIsMobileNavOpen(false);
                }}
                className={`text-sm text-left py-2 elegant-hover ${currentView === 'PROVIDER_LISTING' ? 'font-black' : 'text-gray-700'}`}
                style={currentView === 'PROVIDER_LISTING' ? { color: '#1a5f3f' } : {}}
              >
                特選魚市
              </button>
              <button
                onClick={() => {
                  handleNavigation('FORUM');
                  setIsMobileNavOpen(false);
                }}
                className={`text-sm text-left py-2 elegant-hover ${currentView === 'FORUM' || currentView === 'POST_DETAIL' || currentView === 'CREATE_POST' ? 'font-black' : 'text-gray-700'}`}
                style={currentView === 'FORUM' || currentView === 'POST_DETAIL' || currentView === 'CREATE_POST' ? { color: '#1a5f3f' } : {}}
              >
                御茶室
              </button>
              <button
                onClick={() => handleNavigation('NEWS')}
                className={`text-sm text-left py-2 elegant-hover ${currentView === 'NEWS' || currentView === 'ARTICLE_DETAIL' ? 'font-black' : 'text-gray-700'}`}
                style={currentView === 'NEWS' || currentView === 'ARTICLE_DETAIL' ? { color: '#1a5f3f' } : {}}
              >
                御前茶訊
              </button>
              <button
                onClick={() => {
                  handleNavigation('ABOUT');
                  setIsMobileNavOpen(false);
                }}
                className={`text-sm text-left py-2 elegant-hover ${currentView === 'ABOUT' ? 'font-black' : 'text-gray-700'}`}
                style={currentView === 'ABOUT' ? { color: '#1a5f3f' } : {}}
              >
                關於茶王
              </button>
              <div className="border-t border-gray-200 mt-4 pt-4">
                {isAuthenticated ? (
                  <>
                    {/* 用戶資訊卡片 - 可點擊進入個人檔案（茶客檔案/佳麗檔案） */}
                    <button
                      onClick={() => {
                        handleNavigation('USER_PROFILE');
                        setIsMobileNavOpen(false);
                      }}
                      className="w-full bg-gradient-to-br from-brand-green/5 to-brand-green/10 rounded-2xl p-4 mb-4 border border-brand-green/20 hover:from-brand-green/10 hover:to-brand-green/20 hover:border-brand-green/40 transition-all active:scale-[0.98]" 
                      style={{ backgroundColor: 'rgba(26, 95, 63, 0.05)', borderColor: 'rgba(26, 95, 63, 0.2)' }}
                    >
                      <div className="flex items-center gap-3">
                        {/* 頭像 */}
                        <div className="relative">
                          {user?.avatarUrl ? (
                            <img
                              src={user.avatarUrl}
                              alt="頭像"
                              className="w-12 h-12 rounded-full object-cover border-2 border-white shadow-md"
                            />
                          ) : (
                            <div className="w-12 h-12 rounded-full bg-brand-green/20 flex items-center justify-center border-2 border-white shadow-md" style={{ backgroundColor: 'rgba(26, 95, 63, 0.2)' }}>
                              <img
                                src={getImageUrl("/images/default-avatar.svg")}
                                alt="默認頭像"
                                className="w-8 h-8"
                                onError={(e) => {
                                  const target = e.target as HTMLImageElement;
                                  target.style.display = 'none';
                                }}
                              />
                            </div>
                          )}
                          {/* 角色標識 */}
                          <div className="absolute -bottom-1 -right-1 w-5 h-5 rounded-full bg-white border-2 border-white flex items-center justify-center shadow-sm">
                            {user?.role === 'provider' ? (
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                              </svg>
                            ) : user?.role === 'client' ? (
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                              </svg>
                            ) : (
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                              </svg>
                            )}
                          </div>
                        </div>
                        
                        {/* 用戶資訊 */}
                        <div className="flex-1 min-w-0 text-left">
                          <div className="flex items-center gap-2 mb-1">
                            <p className="text-sm font-bold text-gray-900 truncate">
                              {user?.userName || user?.email?.split('@')[0] || user?.phoneNumber || '用戶'}
                            </p>
                            {user?.role === 'admin' && <AdminBadge size="sm" />}
                            {user?.isVip && <VipBadge size="sm" />}
                            {user?.membershipLevel && user.membershipLevel !== 'tea_guest' && (
                              <MembershipBadge level={user.membershipLevel} size="sm" />
                            )}
                            {user?.verificationBadges && user.verificationBadges.length > 0 && (
                              <VerificationBadges badges={user.verificationBadges} size="sm" />
                            )}
                          </div>
                          <p className="text-xs text-gray-500 truncate">
                            {user?.email || user?.phoneNumber || ''}
                          </p>
                        </div>
                        
                        {/* 右側箭頭指示 */}
                        <svg className="w-5 h-5 text-brand-green/60 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                        </svg>
                      </div>
                    </button>
                    
                    {/* 功能按鈕組 */}
                    <div className="space-y-1">
                      <button
                        onClick={() => {
                          logout();
                          setIsMobileNavOpen(false);
                        }}
                        className="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-white border border-red-200 hover:bg-red-50 hover:border-red-300 transition-all group mt-2"
                      >
                        <div className="w-8 h-8 rounded-lg bg-red-100 flex items-center justify-center group-hover:bg-red-200 transition-colors">
                          <svg className="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                          </svg>
                        </div>
                        <span className="text-sm font-medium text-red-600">登出</span>
                        <svg className="w-4 h-4 text-red-400 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                        </svg>
                      </button>
                    </div>
                  </>
                ) : (
                  <button
                    onClick={() => {
                      setShowAuthModal(true);
                      setAuthModalMode('login');
                      setIsMobileNavOpen(false);
                    }}
                    className="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-brand-green text-white font-medium text-sm hover:bg-opacity-90 transition-all shadow-md"
                    style={{ backgroundColor: '#1a5f3f' }}
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                    </svg>
                    <span>登入/註冊</span>
                  </button>
                )}
              </div>
            </div>
          </div>
        )}
      </header>

      {/* 主內容區 */}
      <main className="max-w-7xl mx-auto px-4 py-12">
        <div className={`flex flex-col lg:flex-row gap-12 ${currentView === 'HOME' ? '' : 'justify-center'}`}>
          
          <div className="flex-1 w-full">
            {/* 視圖切換邏輯 */}
            {currentView === 'HOME' && (
              <div className="animate-fade-in-up">
                {/* Banner - 16:9 比例 - 固定尺寸避免 CLS */}
                <div className="relative w-full rounded-2xl overflow-hidden mb-8 shadow-lg bg-gray-100" style={{ aspectRatio: '16/9', minHeight: '200px' }}>
                  <div 
                    className="absolute inset-0 bg-cover bg-center"
                    style={{ 
                      backgroundImage: `url(${getImageUrl("/images/tea_king_jp_4cs6eng0g.jpg")})`,
                      backgroundSize: 'cover',
                      backgroundPosition: 'center',
                      backgroundRepeat: 'no-repeat',
                      width: '100%',
                      height: '100%'
                    }}
                  >
                    <div className="absolute inset-0 bg-gradient-to-r from-black/60 to-black/40"></div>
                    <div className="relative h-full flex items-center justify-center px-6">
                      <div className="text-center text-white">
                        <h1 className="text-4xl md:text-5xl font-black mb-4 drop-shadow-lg">嚴選好茶</h1>
                        <p className="text-lg md:text-xl opacity-90 drop-shadow-md">茶室皇家精選，品質保證</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="flex items-center justify-between mb-10">
                    <div>
                        <h2 className="text-3xl font-serif font-black text-brand-black">茶室皇家精選</h2>
                        <p className="text-xs text-gray-400 font-bold uppercase tracking-[0.3em] mt-2">Royal Selection</p>
                    </div>
                    <div className="hidden sm:flex gap-2 items-center">
                         <div className="h-1.5 w-12 bg-brand-yellow rounded-full"></div>
                         <div className="h-1.5 w-4 bg-gray-200 rounded-full"></div>
                    </div>
                </div>

                {/* 搜索框 */}
                <div className="mb-6">
                  <div className="relative">
                    <input
                      type="text"
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      placeholder="搜尋茶茶名字、地區、標籤..."
                      className="w-full px-4 py-3 pl-12 pr-4 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-brand-green focus:border-transparent text-sm"
                      style={{ focusRingColor: '#1a5f3f' }}
                    />
                    <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      </svg>
                    </div>
                    {searchQuery && (
                      <button
                        onClick={() => setSearchQuery('')}
                        className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    )}
                  </div>
                </div>

                {/* 載入狀態 */}
                {isLoading && (
                  <div className="py-40 text-center bg-white rounded-[3rem] border-2 border-dashed border-gray-100">
                    <div className="animate-spin w-12 h-12 border-4 border-brand-yellow border-t-transparent rounded-full mx-auto mb-4"></div>
                    <h3 className="text-xl font-serif font-black text-gray-400">載入中...</h3>
                  </div>
                )}

                {/* 錯誤訊息 */}
                {error && !isLoading && (
                  <div className="py-8 px-6 mb-6 bg-red-50 border-2 border-red-200 rounded-2xl">
                    <div className="flex items-center justify-between">
                      <div>
                        <h3 className="text-lg font-bold text-red-800 mb-2">⚠️ 載入資料失敗</h3>
                        <p className="text-sm text-red-600">{error}</p>
                      </div>
                      <button 
                        onClick={loadData} 
                        className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-bold hover:bg-red-700 transition-colors"
                      >
                        重試
                      </button>
                    </div>
                  </div>
                )}

                {/* Profiles 列表 */}
                {!isLoading && (
                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
                    {filteredProfiles.length === 0 ? (
                          <div className="col-span-full py-40 text-center bg-white rounded-3xl border-2 border-dashed border-gray-100">
                            <h3 className="text-xl font-serif font-black text-gray-400">目前沒有符合條件的內容</h3>
                            <button onClick={() => setFilters({ type: 'all', location: '全部', nationalities: [], bodyTypes: [], personalities: [], ageRange: [0, 200], priceRange: [0, 200000], cup: [] })} className="mt-6 px-6 py-2 bg-brand-black text-white rounded-full text-xs font-bold uppercase">重置篩選</button>
                        </div>
                    ) : (
                        <>
                        {paginatedProfiles.map(p => (
                            <a
                                key={p.id}
                                href={`#profile-${p.id}`}
                                className="group cursor-pointer japanese-card-border premium-card-shadow elegant-hover relative bg-white block" 
                                style={{ 
                                    borderRadius: '16px',
                                    overflow: 'hidden'
                                }} 
                                onClick={(e) => {
                                  e.preventDefault();
                                  handleNavigation('PROFILE_DETAIL', p);
                                }}
                            >
                                {/* 圖片容器 - 優化 LCP */}
                                <div className="relative overflow-hidden bg-gray-100" style={{ aspectRatio: '3 / 4' }}>
                                    <img 
                                        src={getImageUrl(p.imageUrl)} 
                                        alt={p.name}
                                        className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700" 
                                        loading={paginatedProfiles.indexOf(p) < 6 ? "eager" : "lazy"}
                                        decoding="async"
                                        fetchPriority={paginatedProfiles.indexOf(p) < 6 ? "high" : "low"}
                                        width={400}
                                        height={533}
                                    />
                                    
                                    {/* 收藏按钮 */}
                                    {isAuthenticated && user?.role === 'client' && (
                                      <FavoriteButton profileId={p.id} />
                                    )}
                                    
                                    {/* 原有的標籤和文字 */}
                                    <div className="absolute top-5 left-5 flex flex-col gap-2 z-10">
                                        <span className={`text-white font-black px-3 py-1 rounded-lg ${p.type === 'incall' ? 'bg-blue-600' : 'bg-brand-black'}`} style={{ fontSize: '10px' }}>
                                            {p.type === 'incall' ? '🏠 定點' : '🚗 外送'}
                                        </span>
                                    </div>
                                    
                                    <div className="absolute bottom-0 left-0 right-0 p-8 bg-gradient-to-t from-black/80 to-transparent z-10">
                                        <div className="flex justify-between items-end text-white">
                                            <div>
                                                <h3 className="text-2xl font-serif font-black">{p.name} {p.nationality}</h3>
                                                <div className="flex gap-2 mt-2 opacity-80 font-bold" style={{ fontSize: '10px' }}>
                                                    <span>{p.age}歲</span><span>{'|'}</span><span>{p.cup}罩杯</span><span>{'|'}</span><span>{p.location}</span>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <PriceDisplay 
                                                  price={p.price} 
                                                  prices={p.prices}
                                                  type={p.type}
                                                  showWarning={true}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        ))}
                        
                        {/* 分页控件 */}
                        {totalPages > 1 && (
                          <div className="col-span-full mt-12 flex items-center justify-center gap-4">
                            <button
                              onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                              disabled={currentPage === 1}
                              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                currentPage === 1
                                  ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                  : 'bg-brand-green text-white hover:bg-opacity-90'
                              }`}
                              style={currentPage !== 1 ? { backgroundColor: '#1a5f3f' } : {}}
                            >
                              上一頁
                            </button>
                            
                            <div className="flex items-center gap-2">
                              {Array.from({ length: Math.min(7, totalPages) }, (_, i) => {
                                let pageNum: number;
                                if (totalPages <= 7) {
                                  pageNum = i + 1;
                                } else if (currentPage <= 4) {
                                  pageNum = i + 1;
                                } else if (currentPage >= totalPages - 3) {
                                  pageNum = totalPages - 6 + i;
                                } else {
                                  pageNum = currentPage - 3 + i;
                                }
                                
                                return (
                                  <button
                                    key={pageNum}
                                    onClick={() => setCurrentPage(pageNum)}
                                    className={`w-10 h-10 rounded-lg font-medium transition-colors ${
                                      currentPage === pageNum
                                        ? 'bg-brand-green text-white'
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                    }`}
                                    style={currentPage === pageNum ? { backgroundColor: '#1a5f3f' } : {}}
                                  >
                                    {pageNum}
                                  </button>
                                );
                              })}
                            </div>
                            
                            <button
                              onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                              disabled={currentPage === totalPages}
                              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                currentPage === totalPages
                                  ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                  : 'bg-brand-green text-white hover:bg-opacity-90'
                              }`}
                              style={currentPage !== totalPages ? { backgroundColor: '#1a5f3f' } : {}}
                            >
                              下一頁
                            </button>
                          </div>
                        )}
                        
                        {/* 顯示當前頁資訊 */}
                        {filteredProfiles.length > 0 && (
                          <div className="col-span-full mt-4 text-center text-sm text-gray-500">
                            顯示第 {startIndex + 1}-{Math.min(endIndex, filteredProfiles.length)} 項，共 {filteredProfiles.length} 項
                          </div>
                        )}
                        </>
                    )}
                </div>
                )}
              </div>
            )}

            {currentView === 'NEWS' && (
              <div className="animate-fade-in-up w-full">
                {/* Banner - 16:9 比例 */}
                <div className="relative w-full rounded-2xl overflow-hidden mb-8 shadow-lg" style={{ aspectRatio: '16/9' }}>
                  <div 
                    className="absolute inset-0 bg-cover bg-center"
                    style={{ 
                      backgroundImage: `url(${getImageUrl("/images/tea_king_jp_jylllrdh4.jpg")})`,

                      backgroundSize: 'cover',
                      backgroundPosition: 'center',
                      backgroundRepeat: 'no-repeat'
                    }}
                  >
                    <div className="absolute inset-0 bg-gradient-to-r from-black/60 to-black/40"></div>
                    <div className="relative h-full flex items-center justify-center px-6">
                      <div className="text-center text-white">
                        <h1 className="text-4xl md:text-5xl font-black mb-4 drop-shadow-lg">御前茶訊</h1>
                        <p className="text-lg md:text-xl opacity-90 drop-shadow-md">茶王親示 · 最新消息與重要提醒</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="mb-12 border-b border-gray-100 pb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
                    <div>
                        <h2 className="text-4xl font-serif font-black text-brand-black">御前茶訊</h2>
                        <p className="text-xs text-gray-400 font-bold uppercase tracking-[0.3em] mt-2">Latest News & Announcements</p>
                    </div>
                    {user?.role === 'admin' && (
                      <button
                        onClick={() => setEditingArticle({} as Article)}
                        className="px-6 py-2 bg-brand-green text-white rounded-lg hover:bg-opacity-90 font-medium flex items-center gap-2"
                        style={{ backgroundColor: '#1a5f3f' }}
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                        發佈新文章
                      </button>
                    )}
                </div>
                {isLoading && articles.length === 0 ? (
                  // 骨架屏 - 提升 LCP，讓用戶更快看到內容結構
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    {[...Array(6)].map((_, i) => (
                      <div key={i} className="bg-white rounded-3xl shadow-sm border border-gray-50 overflow-hidden animate-pulse">
                        <div className="aspect-[16/10] bg-gray-200"></div>
                        <div className="p-7 space-y-3">
                          <div className="h-6 bg-gray-200 rounded w-3/4"></div>
                          <div className="h-4 bg-gray-200 rounded w-full"></div>
                          <div className="h-4 bg-gray-200 rounded w-2/3"></div>
                          <div className="flex justify-between items-center pt-5 border-t border-gray-50">
                            <div className="h-3 bg-gray-200 rounded w-20"></div>
                            <div className="h-3 bg-gray-200 rounded w-16"></div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : error ? (
                  <div className="py-8 px-6 mb-6 bg-red-50 border-2 border-red-200 rounded-2xl">
                    <div className="flex items-center justify-between">
                      <div>
                        <h3 className="text-lg font-bold text-red-800 mb-2">⚠️ 載入資料失敗</h3>
                        <p className="text-sm text-red-600">{error}</p>
                      </div>
                      <button 
                        onClick={loadData} 
                        className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-bold hover:bg-red-700 transition-colors"
                      >
                        重試
                      </button>
                    </div>
                  </div>
                ) : editingArticle !== null ? (
                  <AdminArticleEditor
                    onSave={(article) => {
                      setArticles([article, ...articles]);
                      setEditingArticle(null);
                      loadData();
                    }}
                    onCancel={() => setEditingArticle(null)}
                  />
                ) : (
                <NewsList articles={articles} onArticleClick={(a) => handleNavigation('ARTICLE_DETAIL', a)} />
                )}
              </div>
            )}

            {currentView === 'PROFILE_DETAIL' && selectedProfile && (
                <ProfileDetail 
                  profile={selectedProfile} 
                  onBack={() => handleNavigation(profileDetailSource === 'PROVIDER_LISTING' ? 'PROVIDER_LISTING' : 'HOME')} 
                />
            )}

            {currentView === 'ARTICLE_DETAIL' && selectedArticle && (
                <ArticleDetail 
                  article={selectedArticle} 
                  onBack={() => handleNavigation('NEWS')}
                  allArticles={articles}
                  onArticleClick={(article) => handleNavigation('ARTICLE_DETAIL', article)}
                />
            )}


            {currentView === 'ADMIN_PROFILE' && (
                <AdminEditor 
                    initialData={editingProfile} 
                    allProfiles={profiles}
                    onSave={handleSaveProfile} 
                    onCancel={() => handleNavigation('HOME')} 
                />
            )}

            {currentView === 'PROVIDER_LISTING' && (
                <ProviderListingPage 
                    onProfileClick={(profile) => handleNavigation('PROFILE_DETAIL', profile)}
                />
            )}

            {currentView === 'PROVIDER_DASHBOARD' && (
              <ProviderDashboard />
            )}

            {currentView === 'USER_PROFILE' && (
              <UserProfile onProfileClick={(profile) => handleNavigation('PROFILE_DETAIL', profile)} />
            )}

            {currentView === 'USER_BLOG' && selectedUserId && selectedUserId.trim() !== '' && (
              <UserBlogPage
                userId={selectedUserId}
                onBack={() => {
                  // 如果有之前的視圖，返回之前的視圖；否則返回首頁
                  if (previousView) {
                    handleNavigation(previousView);
                    setPreviousView(null); // 清除之前的視圖記錄
                  } else {
                    // 嘗試使用瀏覽器歷史記錄返回
                    if (window.history.length > 1) {
                      window.history.back();
                    } else {
                      handleNavigation('HOME');
                    }
                  }
                }}
              />
            )}

            {currentView === 'FORUM' && !selectedPostId && (
              <ForumPage 
                onPostClick={(postId) => setSelectedPostId(postId)}
                onCreatePost={() => handleNavigation('CREATE_POST')}
              />
            )}

            {currentView === 'FORUM' && selectedPostId && (
              <PostDetail
                postId={selectedPostId}
                onBack={() => setSelectedPostId(null)}
                onProfileClick={(profile) => handleNavigation('PROFILE_DETAIL', profile)}
                onNavigateToCategory={(category) => {
                  setSelectedPostId(null);
                  handleNavigation('FORUM');
                  if (category) {
                    setTimeout(() => {
                      window.dispatchEvent(new CustomEvent('forum-set-category', { detail: { category } }));
                    }, 100);
                  }
                }}
                onPostClick={(newPostId) => setSelectedPostId(newPostId)}
              />
            )}

            {currentView === 'CREATE_POST' && (
              <CreatePostPage
                onBack={() => handleNavigation('FORUM')}
                onSuccess={() => {
                  // 發茶帖成功後返回論壇頁面
                  handleNavigation('FORUM');
                }}
              />
            )}

            {currentView === 'ABOUT' && (
              <AboutTeaKing
                onBack={previousView ? () => handleNavigation(previousView) : undefined}
                onNavigateToForum={() => handleNavigation('FORUM')}
                onNavigateToNews={() => handleNavigation('NEWS')}
              />
            )}

            {currentView === 'NOT_FOUND' && (
              <NotFound
                onBack={() => handleNavigation('HOME')}
              />
            )}
          </div>


        </div>
      </main>

      {/* 頁尾 */}
      <footer className="bg-white border-t border-gray-100 py-20 mt-20 relative" style={{
        borderTop: '2px solid rgba(26, 95, 63, 0.1)'
      }}>
          {/* Japanese decorative line */}
          <div className="japanese-line"></div>
          <div className="max-w-7xl mx-auto px-4 text-center">
              <div className="w-12 h-12 flex items-center justify-center mx-auto mb-6 overflow-hidden relative" style={{
                background: 'transparent'
              }}>
                <img
                  src={getImageUrl("/images/關於茶王/旗幟.png")}
                  alt="茶王旗幟"
                  className="w-full h-full object-contain"
                  style={{
                    filter: 'drop-shadow(0 2px 4px rgba(26, 95, 63, 0.3))',
                    animation: 'flagWave 3s ease-in-out infinite',
                    transformOrigin: 'center center',
                    width: '48px',
                    height: 'auto'
                  }}
                  onError={(e) => {
                    const target = e.target as HTMLImageElement;
                    if (target.parentElement) {
                      target.parentElement.innerHTML = '<span class="text-white font-black text-2xl" style="background: linear-gradient(135deg, #1a5f3f 0%, #15803d 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">茶</span>';
                    }
                  }}
                />
              </div>
              <p className="text-brand-black text-sm font-black tracking-[0.3em] uppercase mb-4">一本道品茶，只為懂茶的你</p>
              <p className="text-gray-300 text-[10px]">© 2025 茶王 ALL RIGHTS RESERVED.</p>
          </div>
      </footer>

      {/* 底部狀態欄：顯示時間和在線人數 */}
      <Footer />

      <style>{`
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes flagWave {
          0%, 100% {
            transform: scale(1) rotate(0deg);
          }
          25% {
            transform: scale(1.05) rotate(-2deg);
          }
          50% {
            transform: scale(1) rotate(0deg);
          }
          75% {
            transform: scale(1.05) rotate(2deg);
          }
        }
      `}</style>


      {/* 认证模态框 */}
      {showAuthModal && (
        <AuthModal
          onClose={() => setShowAuthModal(false)}
          initialMode={authModalMode}
        />
      )}

      {/* 歡迎彈窗（首次登入） */}
      {showWelcomeModal && user && (
        <WelcomeModal
          isOpen={showWelcomeModal}
          onClose={() => setShowWelcomeModal(false)}
          userName={user.userName || user.email?.split('@')[0] || user.phoneNumber}
          userRole={user.role}
        />
      )}
    </div>
  );
};

export default App;